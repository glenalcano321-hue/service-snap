<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/jpeg" href="logo.jpg" sizes="32x32">
  <title>ServiceSnap</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>

  <style>
    :root{ --bg:#ffffff; --card:#ffffff; --text:#004242; --muted:#9aa2b1; --accent:#3b82f6; --border:#1f2937; --hover:#756a6a; --success:#10b981; }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,sans-serif; min-height:100vh; }

    /* Dropdown */
    .Dropdown { position: relative; display: inline-block; }
    .dropdown-content { display: none; position: absolute; right: 0; top: 110%; background-color: var(--card); min-width: 200px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); border: 1px solid #e5e7eb; border-radius: 12px; z-index: 1000; overflow: hidden; animation: slideDown 0.2s ease-out; }
    .dropdown-content.show{ display: block; }
    .dropdown-item { color: var(--text); padding: 12px 16px; text-decoration: none; display: flex; align-items: center; gap: 12px; transition: background 0.2s; cursor: pointer; font-size: 0.95rem; }
    .dropdown-item:hover { background-color: #f3f4f6; }
    .text-danger { color: #ef4444; }
    .text-danger:hover { background-color: #fef2f2; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    /* Header */
    .header { background:var(--card); border-bottom:1px solid #e5e7eb; padding:16px 24px; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:100; }
    .logo { display: flex; align-items: center; font-weight:800; font-size:1.4rem; cursor:pointer; }
    .logo-icon { width: 2rem; height: 2rem; vertical-align: middle; margin-right: 8px; }
    .search-container { flex:1; max-width:400px; margin:0 24px; position:relative; }
    .search-bar { width:100%; background:#f9fafb; border:1px solid #e5e7eb; border-radius:24px; padding:12px 16px 12px 40px; color:var(--text); font-size:14px; }
    .search-icon { position:absolute; left:14px; top:50%; transform:translateY(-50%); color:var(--muted); }
    .user-menu { display:flex; align-items:center; gap:12px; }
    .avatar { width:40px; height:40px; border-radius:50%; background:var(--accent); display:grid; place-items:center; font-weight:700; color:white; cursor:pointer; }

    /* Sidebar & Layout */
    .layout { display:flex; min-height:calc(100vh - 73px); }
    .sidebar { width:240px; background:var(--card); border-right:1px solid #e5e7eb; padding:24px 0; }
    .nav-item { display:flex; align-items:center; padding:12px 24px; color:var(--muted); text-decoration:none; transition:all 0.2s; gap:12px; cursor:pointer; }
    .nav-item:hover, .nav-item.active { background:#f3f4f6; color:var(--text); }
    .nav-icon { width:20px; height:20px; display:grid; place-items:center; }

    /* Main Content */
    .main { flex:1; padding:24px; max-width:1200px; }
    .page-title { margin:0 0 24px; font-size:2rem; font-weight:700; }
    .page-subtitle { margin:0 0 32px; color:var(--muted); font-size:1.1rem; }

    /* Services Grid */
    .services-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:20px; margin-bottom:40px; }
    .service-card { background:var(--card); border:1px solid #e5e7eb; border-radius:16px; padding:24px; cursor:pointer; transition:all 0.2s; text-align:center; }
    .service-card:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(0,0,0,0.1); border-color:var(--accent); }
    .service-icon { width:60px; height:60px; margin:0 auto 16px; background:linear-gradient(135deg, var(--accent), #6366f1); border-radius:16px; display:grid; place-items:center; font-size:24px; }
    .service-title { margin:0 0 8px; font-size:1.2rem; font-weight:600; }
    .service-description { margin:0 0 16px; color:var(--muted); font-size:0.9rem; line-height:1.4; }
    .service-stats { display:flex; justify-content:space-between; align-items:center; padding-top:16px; border-top:1px solid #e5e7eb; font-size:0.85rem; }
    .stat-item { display:flex; align-items:center; gap:4px; color:var(--muted); }

    /* Provider Cards */
    .provider-card { background:var(--card); border:1px solid #e5e7eb; border-radius:16px; padding:20px; display:flex; gap:16px; align-items:center; margin-bottom:16px; transition:all 0.2s; cursor:pointer; }
    .provider-card:hover { transform:translateY(-1px); border-color:var(--accent); box-shadow:0 4px 15px rgba(0,0,0,0.1); }
    .provider-avatar { width:60px; height:60px; border-radius:50%; background:linear-gradient(135deg, var(--accent), #6366f1); display:grid; place-items:center; font-weight:700; font-size:1.2rem; color:white; }
    .provider-photo { width:60px; height:60px; border-radius:50%; object-fit:cover; border:2px solid #e5e7eb; }
    .provider-info { flex:1; }
    
    /* UPDATED: Provider Name Alignment */
    .provider-name { 
      margin:0 0 4px; 
      font-size:1.1rem; 
      font-weight:600; 
      display: flex; /* Flexbox for alignment */
      align-items: center; /* Vertical center */
      gap: 6px; /* Space between name and badge */
    }
    .verified-icon { width: 1.1rem; height: 1.1rem; object-fit: contain; }
    
    .provider-details { margin:0; color:var(--muted); font-size:0.9rem; line-height:1.4; }
    .provider-specialties { color: var(--accent); font-size: 0.85rem; margin-top: 4px; font-weight: 500; }
    .provider-rating { display:flex; align-items:center; gap:8px; margin-top:8px; }
    .provider-actions { display:flex; flex-direction:column; gap:8px; }

    /* Profile Page */
    .profile-header { background:var(--card); border-radius:16px; padding:32px; margin-bottom:24px; display:flex; gap:24px; align-items:flex-start; border: 1px solid #e5e7eb; }
    .profile-photo { width:120px; height:120px; border-radius:50%; object-fit:cover; border:4px solid var(--accent); flex-shrink:0; display:grid; place-items:center; font-size:2.5rem; font-weight:700; color:white; }
    .profile-details { flex:1; }
    .profile-name { margin:0 0 8px; font-size:2rem; font-weight:700; display: flex; align-items: center; gap: 8px; }
    .profile-title { margin:0 0 16px; color:var(--accent); font-size:1.1rem; font-weight:600; }
    .profile-meta { display:flex; gap:24px; flex-wrap:wrap; margin-bottom:16px; }
    .meta-item { display:flex; align-items:center; gap:8px; color:var(--muted); }
    .profile-actions { display:flex; gap:12px; margin-top:24px; }

    .profile-grid { display:grid; grid-template-columns:2fr 1fr; gap:24px; }
    .profile-section { background:var(--card); border-radius:16px; padding:24px; margin-bottom:24px; border: 1px solid #e5e7eb; }
    .section-title { margin:0 0 16px; font-size:1.3rem; font-weight:600; display:flex; align-items:center; gap:8px; }
    .section-content { color:var(--muted); line-height:1.6; }

    /* Calendar Styling */
    .calendar-wrapper { display: flex; justify-content: center; background: #f8fafc; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; }
    .flatpickr-calendar { box-shadow: none !important; background: transparent !important; }
    .calendar-legend { display: flex; gap: 16px; font-size: 0.85rem; margin-top: 10px; justify-content: center; color: var(--muted); }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; }
    .dot.booked { background: #ef4444; }
    .dot.available { background: #fff; border: 1px solid #ccc; }

    /* Portfolio */
    .portfolio-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-top:16px; }
    .portfolio-item { aspect-ratio:1; border-radius:12px; background:#f3f4f6; border:1px solid #e5e7eb; display:grid; place-items:center; cursor:pointer; transition:all 0.2s; overflow:hidden; }
    .portfolio-item:hover { transform:scale(1.05); border-color:var(--accent); }
    .portfolio-img { width:100%; height:100%; object-fit:cover; }

    /* Reviews */
    .review-item { padding:16px 0; border-bottom:1px solid #e5e7eb; }
    .review-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .review-author { font-weight:600; }
    .review-date { color:var(--muted); font-size:0.85rem; }
    .review-text { color:var(--muted); line-height:1.5; }

    /* General Buttons */
    .btn { background:var(--accent); color:#fff; border:none; border-radius:12px; padding:12px 24px; cursor:pointer; font-weight:600; text-decoration:none; display:inline-block; transition:all 0.2s; }
    .btn:hover { background:#2563eb; transform:translateY(-1px); }
    .btn-outline { background:transparent; border:1px solid #e5e7eb; color:var(--text); }
    .btn-outline:hover { background:#f3f4f6; }
    .btn-sm { padding:8px 16px; font-size:0.85rem; }
    .btn-success { background:var(--success); }
    .back-btn { background:transparent; border:1px solid #e5e7eb; color:var(--text); border-radius:12px; padding:10px 16px; cursor:pointer; font-weight:600; margin-bottom:24px; display:inline-flex; align-items:center; gap:8px; }
    .back-btn:hover { background:#f3f4f6; border-color:var(--accent); }
    .see-all-container { text-align:center; margin:40px 0; }
    .hidden { display: none !important; }

    /* Chat Widget */
    .chat-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; display: flex; justify-content: center; align-items: center; }
    .chat-widget { width: 90%; max-width: 500px; height: 600px; background: var(--card); border-radius: 16px; border: 1px solid var(--border); display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); animation: slideUp 0.3s ease-out; }
    .chat-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; background: var(--card); border-radius: 16px 16px 0 0; }
    .chat-close { margin-left: auto; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); }
    .chat-provider-avatar { width: 48px; height: 48px; border-radius: 50%; display: grid; place-items: center; font-weight: 700; font-size: 1.1rem; color: white; }
    .chat-provider-details h4 { margin: 0; font-size: 1.1rem; font-weight: 600; }
    .chat-provider-details p { margin: 4px 0 0; color: var(--muted); font-size: 0.9rem; }
    .chat-status { display: flex; align-items: center; gap: 6px; color: var(--success); font-size: 0.85rem; }
    .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
    .chat-message { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 0.9rem; line-height: 1.4; }
    .chat-message.received { background: #f3f4f6; color: var(--text); align-self: flex-start; border-bottom-left-radius: 6px; }
    .chat-message.sent { background: var(--accent); color: white; align-self: flex-end; border-bottom-right-radius: 6px; }
    .chat-input-container { padding: 20px; border-top: 1px solid var(--border); background: var(--card); border-radius: 0 0 16px 16px; }
    .chat-input-wrapper { display: flex; gap: 12px; align-items: flex-end; }
    .chat-input { flex: 1; background: #f9fafb; border: 1px solid var(--border); border-radius: 24px; padding: 12px 16px; font-size: 0.9rem; resize: none; min-height: 44px; max-height: 120px; font-family: inherit; }
    .chat-send-btn { width: 44px; height: 44px; background: var(--accent); border: none; border-radius: 50%; color: white; cursor: pointer; display: grid; place-items: center; font-size: 18px; transition: all 0.2s; flex-shrink: 0; }
    .chat-quick-replies { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    .quick-reply-btn { background: #f3f4f6; border: 1px solid var(--border); color: var(--text); padding: 8px 12px; border-radius: 16px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
    .quick-reply-btn:hover { background: var(--accent); color: white; }

    @media (max-width: 768px) {
      .layout { flex-direction:column; }
      .sidebar { width:100%; border-right:none; border-bottom:1px solid #e5e7eb; padding:16px 0; }
      .services-grid { grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:16px; }
      .profile-grid { grid-template-columns:1fr; }
      .chat-widget { width: 95%; height: 85vh; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo" onclick="showHomePage()"> <img src="logo.jpg" class= "logo-icon"> ServiceSnap</div>
    <div class="search-container">
      <div class="search-icon">üîç</div>
      <input type="text" class="search-bar" placeholder="Search for services..." id="searchInput">
    </div>
    <div class="user-menu">
      <div class="Dropdown">
        <div class="avatar" id="userAvatar" onclick="toggleUserDropdown()">U</div>
        <div id="userDropdownContent" class="dropdown-content">
          <a href="#" onclick="location.href='profile.html'" class="dropdown-item"><span>üë§</span> My Profile</a>
          <hr style="margin: 0; border: 0; border-top: 1px solid var(--border);">
          <a href="#" id="signOutBtn" class="dropdown-item text-danger"><span>üö™</span> Sign out</a>
        </div>
      </div>
    </div>
  </header>

  <div class="layout">
    <nav class="sidebar">
      <div class="nav-item active" data-category="all" onclick="showHomePage()">
        <div class="nav-icon">üè†</div> All Services
      </div>
      <div class="nav-item" data-category="cleaning" onclick="filterServices('cleaning')">
        <div class="nav-icon">üßπ</div> Cleaning
      </div>
      <div class="nav-item" data-category="childcare" onclick="filterServices('childcare')">
        <div class="nav-icon">üë∂</div> Child Care
      </div>
      <div class="nav-item" data-category="eldercare" onclick="filterServices('eldercare')">
        <div class="nav-icon">üë¥</div> Elder Care
      </div>
      <div class="nav-item" data-category="cooking" onclick="filterServices('cooking')">
        <div class="nav-icon">üë©‚Äçüç≥</div> Cooking
      </div>
      <div class="nav-item" data-category="maintenance" onclick="filterServices('maintenance')">
        <div class="nav-icon">üîß</div> Maintenance
      </div>
      <div class="nav-item" data-category="gardening" onclick="filterServices('gardening')">
        <div class="nav-icon">üå±</div> Gardening
      </div>
    </nav>

    <main class="main" id="mainContent">
      <div id="authContent" class="hidden">
        <div id="homePage">
          <h1 class="page-title" id="pageTitle">ServiceSnap</h1>
          <p class="page-subtitle">Find trusted service providers for your home needs</p>
          <div class="services-grid" id="servicesGrid"></div>
          <div class="services-grid hidden" id="moreServices"></div>
          <div class="see-all-container">
            <button class="btn" id="seeAllBtn">See All Services</button>
          </div>
        </div>
        <div id="providersPage" class="hidden"></div>
        <div id="profilePage" class="hidden"></div>
      </div>
    </main>
  </div>

  <div id="chatOverlay" class="chat-overlay hidden">
    <div class="chat-widget" id="chatWidget">
      <div class="chat-header">
        <div class="chat-provider-info">
          <div class="chat-provider-avatar" id="chatProviderAvatar"></div>
          <div class="chat-provider-details">
            <h4 id="chatProviderName">Provider Name</h4>
            <p id="chatProviderTitle">Service Provider</p>
            <div class="chat-status"><span style="width: 8px; height: 8px; background: var(--success); border-radius: 50%; display: inline-block;"></span> <span>Online</span></div>
          </div>
        </div>
        <button class="chat-close" onclick="closeChatWidget()">√ó</button>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-container">
        <div class="chat-quick-replies" id="quickReplies">
          <button class="quick-reply-btn" onclick="sendQuickReply('What are your rates?')">Rates?</button>
          <button class="quick-reply-btn" onclick="sendQuickReply('Available this weekend?')">Availability?</button>
          <button class="quick-reply-btn" onclick="sendQuickReply('Can you provide references?')">References?</button>
        </div>
        <div class="chat-input-wrapper">
          <textarea class="chat-input" id="chatInput" placeholder="Type your message..." rows="1"></textarea>
          <button class="chat-send-btn" id="chatSendBtn" onclick="sendMessage()">‚û§</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function toggleUserDropdown() {
      document.getElementById("userDropdownContent").classList.toggle("show");
    }
    
    window.onclick = function(event) {
      if (!event.target.matches('.avatar')){
        var dropdowns = document.getElementsByClassName("dropdown-content");
        for (var i = 0; i < dropdowns.length; i++){
          if (dropdowns[i].classList.contains('show')) dropdowns[i].classList.remove('show');
        }
      }
    }

    // --- MOCK SCHEDULE DATA ---
    const mockProviderSchedules = {
      1: ["2025-11-28", "2025-11-29", "2025-12-01"], // Maria
      2: ["2025-11-30", "2025-12-02"], // Ana
      3: ["2025-12-05", "2025-12-06", "2025-12-07"], // Carmen
      4: ["2025-11-28", "2025-12-01"], // Jessica
    };

    // --- FULL MOCK DATA ---
    const createPlaceholder = (text, color = '#e5e7eb') => `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 300'%3E%3Crect width='300' height='300' fill='${encodeURIComponent(color)}'/%3E%3Ctext x='150' y='150' text-anchor='middle' fill='%236b7280' font-size='16' font-family='Arial'%3E${encodeURIComponent(text)}%3C/text%3E%3C/svg%3E`;

    const serviceProviders = {
      cleaning: [
        {
          id: 1, name: "Maria Santos", title: "Professional House Cleaner", location: "Barangay Poblacion, Argao", hourlyRate: "‚Ç±350/hour", rating: 4.9, reviews: 127, verified: true,
          about: "Hi! I'm Maria, a dedicated house cleaner with 5 years of experience. I take pride in transforming homes into spotless spaces.",
          specialties: ["Deep cleaning", "Move-in/out cleaning"],
          services: ["Regular house cleaning", "Deep cleaning services", "Post-construction cleanup"],
          portfolio: [createPlaceholder("Before & After", "#ddd6fe"), createPlaceholder("Kitchen", "#dcfce7"), createPlaceholder("Living Room", "#fef3c7")],
          reviews_detail: [{ author: "Jennifer L.", rating: 5, date: "2 weeks ago", text: "Maria is absolutely fantastic!" }, { author: "Robert K.", rating: 5, date: "1 month ago", text: "Always on time and thorough." }]
        },
        {
          id: 2, name: "Ana Rodriguez", title: "Residential Cleaning Specialist", location: "Barangay Looc, Argao", hourlyRate: "‚Ç±300/hour", rating: 4.7, reviews: 89, verified: true,
          about: "Professional cleaner specializing in apartment and small office spaces.",
          specialties: ["Apartment cleaning", "Office cleaning"],
          services: ["Apartment cleaning", "Weekly maintenance"],
          portfolio: [createPlaceholder("Studio Apt", "#f3e8ff"), createPlaceholder("Office Space", "#ecfdf5")],
          reviews_detail: [{ author: "Mike T.", rating: 5, date: "1 week ago", text: "Efficient and knows exactly what needs attention." }]
        },
        {
          id: 3, name: "Carmen dela Cruz", title: "Eco-Friendly Cleaning Expert", location: "Barangay Tulic, Argao", hourlyRate: "‚Ç±400/hour", rating: 4.8, reviews: 156, verified: true,
          about: "Specializing in eco-friendly and allergy-safe cleaning solutions. Perfect for families with children or pets.",
          specialties: ["Green cleaning", "Pet-friendly"],
          services: ["Eco-friendly cleaning", "Allergy-safe cleaning"],
          portfolio: [createPlaceholder("Eco Products", "#dcfce7"), createPlaceholder("Pet Safe", "#fef3c7")],
          reviews_detail: [{ author: "Amanda S.", rating: 5, date: "5 days ago", text: "Carmen is amazing! Natural cleaning methods made such a difference." }]
        }
      ],
      childcare: [
        {
          id: 4, name: "Jessica Reyes", title: "Professional Nanny", location: "Taguig City", hourlyRate: "‚Ç±250/hour", rating: 4.9, reviews: 95, verified: true,
          about: "Passionate childcare provider with 6 years of experience. I believe in nurturing each child's unique personality.",
          specialties: ["Infant care", "Toddler development"],
          services: ["Infant care", "Toddler supervision", "Light tutoring"],
          portfolio: [createPlaceholder("Play Time", "#fef3c7"), createPlaceholder("Learning", "#dbeafe")],
          reviews_detail: [{ author: "Lisa P.", rating: 5, date: "3 days ago", text: "She's incredibly patient and creative." }]
        }
      ],
      eldercare: [
        {
          id: 6, name: "Grace Martinez", title: "Senior Care Companion", location: "Manila", hourlyRate: "‚Ç±280/hour", rating: 4.9, reviews: 78, verified: true,
          about: "Dedicated senior care professional focusing on dignity and independence for seniors.",
          specialties: ["Companionship", "Medication reminders"],
          services: ["Companionship", "Medication reminders", "Light housekeeping"],
          portfolio: [createPlaceholder("Companion Care", "#f0f9ff"), createPlaceholder("Daily Support", "#fffbeb")],
          reviews_detail: [{ author: "Roberto F.", rating: 5, date: "4 days ago", text: "My mother looks forward to her visits." }]
        }
      ],
      cooking: [
        {
          id: 7, name: "Chef Marco Silva", title: "Personal Chef", location: "BGC", hourlyRate: "‚Ç±500/hour", rating: 4.7, reviews: 65, verified: true,
          about: "Professional chef specializing in healthy, delicious meals tailored to your dietary needs.",
          specialties: ["Healthy meals", "Special diets"],
          services: ["Personal chef services", "Weekly meal prep"],
          portfolio: [createPlaceholder("Filipino Dishes", "#fef3c7"), createPlaceholder("Healthy Meals", "#dcfce7")],
          reviews_detail: [{ author: "Elena K.", rating: 5, date: "1 week ago", text: "Every dish was perfect!" }]
        }
      ],
      maintenance: [
        {
          id: 8, name: "Roberto Santos", title: "Home Maintenance Expert", location: "Quezon City", hourlyRate: "‚Ç±450/hour", rating: 4.6, reviews: 143, verified: true,
          about: "Experienced maintenance professional handling repairs with quality workmanship.",
          specialties: ["Electrical", "Plumbing"],
          services: ["Electrical repairs", "Plumbing services", "General repairs"],
          portfolio: [createPlaceholder("Electrical Work", "#fef3c7"), createPlaceholder("Plumbing", "#dbeafe")],
          reviews_detail: [{ author: "Carlos D.", rating: 5, date: "3 days ago", text: "Fixed our electrical issues quickly." }]
        }
      ],
      gardening: [
        {
          id: 10, name: "Antonio Verde", title: "Landscape Specialist", location: "Alabang", hourlyRate: "‚Ç±320/hour", rating: 4.4, reviews: 87, verified: true,
          about: "Professional landscaper creating beautiful, sustainable gardens.",
          specialties: ["Landscaping", "Plant care"],
          services: ["Garden design", "Plant care", "Lawn care"],
          portfolio: [createPlaceholder("Garden Design", "#dcfce7"), createPlaceholder("Landscaping", "#f0fdf4")],
          reviews_detail: [{ author: "Sandra L.", rating: 5, date: "2 weeks ago", text: "Transformed our backyard." }]
        }
      ]
    };

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyDBOmdxfRixu9DGdCEf4HD2DCxbHX2LNNU",
      authDomain: "finding-service-auth.firebaseapp.com",
      projectId: "finding-service-auth",
      storageBucket: "finding-service-auth.appspot.com",
      messagingSenderId: "404280706761",
      appId: "1:404280706761:web:8c808b583447b133832f18"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const featuredCategories = [
      { id: 'cleaning', title: 'House Cleaning', description: 'Professional cleaning services', icon: 'üßπ', providers: 156, avgRating: 4.8, category: 'cleaning' },
      { id: 'childcare', title: 'Child Care', description: 'Trusted nannies', icon: 'üë∂', providers: 89, avgRating: 4.9, category: 'childcare' },
      { id: 'eldercare', title: 'Elder Care', description: 'Compassionate care', icon: 'üë¥', providers: 67, avgRating: 4.7, category: 'eldercare' }
    ];
    const moreCategories = [
      { id: 'cooking', title: 'Personal Chef', description: 'Home cooking', icon: 'üë©‚Äçüç≥', providers: 43, avgRating: 4.6, category: 'cooking' },
      { id: 'maintenance', title: 'Home Maintenance', description: 'Repairs', icon: 'üîß', providers: 124, avgRating: 4.5, category: 'maintenance' },
      { id: 'gardening', title: 'Garden Care', description: 'Landscaping', icon: 'üå±', providers: 78, avgRating: 4.4, category: 'gardening' }
    ];

    // DOM Elements
    const authContent = document.getElementById('authContent');
    const homePage = document.getElementById('homePage');
    const providersPage = document.getElementById('providersPage');
    const profilePage = document.getElementById('profilePage');
    const servicesGrid = document.getElementById('servicesGrid');
    const moreServicesGrid = document.getElementById('moreServices');
    const searchInput = document.getElementById('searchInput');
    const userAvatar = document.getElementById('userAvatar');
    const signOutBtn = document.getElementById('signOutBtn');
    const navItems = document.querySelectorAll('.nav-item');
    const seeAllBtn = document.getElementById('seeAllBtn');
    const pageTitle = document.getElementById('pageTitle');

    // Chat Elements
    const chatOverlay = document.getElementById('chatOverlay');
    const chatInput = document.getElementById('chatInput');
    const chatMessages = document.getElementById('chatMessages');
    const chatProviderAvatar = document.getElementById('chatProviderAvatar');
    const chatProviderName = document.getElementById('chatProviderName');
    const chatProviderTitle = document.getElementById('chatProviderTitle');
    
    let currentCategory = 'all';
    let currentUser = null;
    let showingAll = false;
    let currentServiceId = null;
    let currentChatProvider = null;

    // --- MAIN FUNCTIONS ---
    function toggleUserDropdown() { document.getElementById("userDropdownContent").classList.toggle("show"); }
    window.onclick = function(event) {
      if (!event.target.matches('.avatar')){
        var dropdowns = document.getElementsByClassName("dropdown-content");
        for (var i = 0; i < dropdowns.length; i++){
          if (dropdowns[i].classList.contains('show')) dropdowns[i].classList.remove('show');
        }
      }
    }

    const initials = (name = '') => name.split(' ').map(p => p[0]).join('').slice(0, 2).toUpperCase() || '??';
    const stars = (rating) => '‚≠ê'.repeat(Math.floor(rating)) + (rating % 1 >= 0.5 ? '‚≠ê' : '');
    const getAvatarColor = (name) => {
      const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
      return colors[name.length % colors.length];
    };

    function showHomePage() {
      homePage.classList.remove('hidden');
      providersPage.classList.add('hidden');
      profilePage.classList.add('hidden');
      
      // Reset sidebar active state
      navItems.forEach(item => {
        item.classList.toggle('active', item.dataset.category === 'all');
      });
      
      pageTitle.textContent = "ServiceSnap";
      renderFeaturedServices();
      renderMoreServices();
      moreServicesGrid.classList.add('hidden');
      seeAllBtn.classList.remove('hidden');
      seeAllBtn.textContent = "See All Services";
      showingAll = false;
    }

    function renderFeaturedServices() { servicesGrid.innerHTML = featuredCategories.map(s => renderServiceCard(s)).join(''); }
    function renderMoreServices() { moreServicesGrid.innerHTML = moreCategories.map(s => renderServiceCard(s)).join(''); }

    function renderServiceCard(service) {
      return `
        <div class="service-card" onclick="openService('${service.id}')">
          <div class="service-icon">${service.icon}</div>
          <h3 class="service-title">${service.title}</h3>
          <p class="service-description">${service.description}</p>
        </div>
      `;
    }

    // --- SEARCH AND FILTER LOGIC ---

    function filterServices(category) {
      if(profilePage.classList.contains('hidden') === false || providersPage.classList.contains('hidden') === false) {
        // If on another page, go to home first
        homePage.classList.remove('hidden');
        providersPage.classList.add('hidden');
        profilePage.classList.add('hidden');
      }

      currentCategory = category;
      
      // Update sidebar
      navItems.forEach(item => {
        item.classList.toggle('active', item.dataset.category === category);
      });

      if (category === 'all') {
        pageTitle.textContent = "ServiceSnap";
        renderFeaturedServices();
        renderMoreServices();
        moreServicesGrid.classList.add('hidden');
        seeAllBtn.classList.remove('hidden');
      } else {
        // Filter logic
        const all = [...featuredCategories, ...moreCategories];
        const filtered = all.filter(s => s.category === category);
        
        pageTitle.textContent = category.charAt(0).toUpperCase() + category.slice(1) + " Services";
        servicesGrid.innerHTML = filtered.map(s => renderServiceCard(s)).join('');
        
        moreServicesGrid.classList.add('hidden');
        seeAllBtn.classList.add('hidden');
      }
    }

    function searchServices(query) {
      if(profilePage.classList.contains('hidden') === false || providersPage.classList.contains('hidden') === false) {
        homePage.classList.remove('hidden');
        providersPage.classList.add('hidden');
        profilePage.classList.add('hidden');
      }

      const all = [...featuredCategories, ...moreCategories];
      const lowerQuery = query.toLowerCase();
      const filtered = all.filter(s => 
        s.title.toLowerCase().includes(lowerQuery) || 
        s.description.toLowerCase().includes(lowerQuery)
      );

      pageTitle.textContent = query ? `Search: "${query}"` : "ServiceSnap";
      servicesGrid.innerHTML = filtered.map(s => renderServiceCard(s)).join('');
      
      moreServicesGrid.classList.add('hidden');
      seeAllBtn.classList.add('hidden');
    }

    searchInput.addEventListener('input', (e) => {
      const val = e.target.value.trim();
      if(val) searchServices(val);
      else filterServices('all'); // Reset
    });

    // --- NAVIGATION LOGIC ---

    function openService(serviceId) {
      currentServiceId = serviceId;
      homePage.classList.add('hidden');
      providersPage.classList.remove('hidden');
      profilePage.classList.add('hidden'); // Fix: ensure profile is hidden
      
      const providers = serviceProviders[serviceId] || [];
      
      providersPage.innerHTML = `
        <button class="back-btn" onclick="showHomePage()">‚Üê Back</button>
        <h1 class="page-title">${serviceId.charAt(0).toUpperCase() + serviceId.slice(1)} Providers</h1>
        <div class="services-grid">
          ${providers.length ? providers.map(p => renderProviderCard(p)).join('') : '<p>No providers available yet.</p>'}
        </div>
      `;
    }

    // --- UPDATED RENDER CARD ---
    function renderProviderCard(p) {
      const bgColor = getAvatarColor(p.name);
      // Construct specialties text
      const specialtiesText = p.specialties ? p.specialties.join(', ') : '';
      
      return `
        <div class="provider-card" onclick="viewProfile('${currentServiceId}', ${p.id})">
          ${p.photo ? `<img src="${p.photo}" class="provider-photo">` : `<div class="provider-avatar" style="background:${bgColor}">${initials(p.name)}</div>`}
          <div class="provider-info">
            <h3 class="provider-name">
              ${p.name}
              ${p.verified ? `<img src="badge.png" class="verified-icon" alt="Verified" />` : ''}
            </h3>
            <p class="provider-details">üìç ${p.location}</p>
            ${specialtiesText ? `<p class="provider-specialties">${specialtiesText}</p>` : ''}
            <div class="provider-rating">‚≠ê ${p.rating}</div>
          </div>
          <button class="btn btn-sm">View Profile</button>
        </div>
      `;
    }

    // --- PROFILE VIEW ---
    function viewProfile(serviceId, providerId) {
      const providers = serviceProviders[serviceId] || [];
      const provider = providers.find(p => p.id === providerId);
      if (!provider) return;

      homePage.classList.add('hidden');
      providersPage.classList.add('hidden');
      profilePage.classList.remove('hidden');

      const bgColor = getAvatarColor(provider.name);
      const portfolioHTML = provider.portfolio ? provider.portfolio.map(img => `<div class="portfolio-item"><img src="${img}" class="portfolio-img"></div>`).join('') : '<p>No portfolio.</p>';
      const reviewsHTML = provider.reviews_detail ? provider.reviews_detail.map(r => `<div class="review-item"><div class="review-header"><span class="review-author">${r.author}</span><span class="review-date">${r.date}</span></div><div class="provider-rating">${stars(r.rating)}</div><p class="review-text">${r.text}</p></div>`).join('') : '<p>No reviews.</p>';
      const servicesHTML = provider.services ? provider.services.map(s => `<li>${s}</li>`).join('') : '';

      profilePage.innerHTML = `
        <button class="back-btn" onclick="openService('${serviceId}')">&larr; Back to List</button>
        
        <div class="profile-header">
          ${provider.photo ? `<img src="${provider.photo}" class="profile-photo">` : `<div class="profile-photo" style="background:${bgColor}">${initials(provider.name)}</div>`}
          <div class="profile-details">
            <h1 class="profile-name">
              ${provider.name}
              ${provider.verified ? `<img src="badge.png" class="verified-icon" style="width:24px;height:24px;" />` : ''}
            </h1>
            <p class="profile-title">${provider.title}</p>
            <div class="profile-meta">
              <span class="meta-item">üìç ${provider.location}</span>
              <span class="meta-item">‚≠ê ${provider.rating} (${provider.reviews} reviews)</span>
            </div>
            <div class="profile-actions">
              <button class="btn btn-success" onclick="location.href='booking.html?providerId=${provider.id}'">Book Now</button>
              <button class="btn btn-outline" onclick="openChatWidget('${serviceId}', ${provider.id})">Message</button>
            </div>
          </div>
        </div>

        <div class="profile-grid">
          <div class="profile-main">
            <div class="profile-section">
              <h3 class="section-title">üìÖ Availability Schedule</h3>
              <div class="calendar-wrapper">
                <div id="providerCalendar"></div>
              </div>
              <div class="calendar-legend">
                <span class="legend-item"><span class="dot available"></span> Available</span>
                <span class="legend-item"><span class="dot booked"></span> Booked</span>
              </div>
            </div>

            <div class="profile-section">
              <h3 class="section-title">About</h3>
              <p>${provider.about}</p>
            </div>
            <div class="profile-section">
              <h3 class="section-title">Services</h3>
              <ul>${servicesHTML}</ul>
            </div>
            <div class="profile-section">
              <h3 class="section-title">Portfolio</h3>
              <div class="portfolio-grid">${portfolioHTML}</div>
            </div>
            <div class="profile-section">
              <h3 class="section-title">Reviews</h3>
              ${reviewsHTML}
            </div>
          </div>

          <div class="profile-sidebar">
            <div class="profile-section">
              <h3 class="section-title">Info</h3>
              <p><strong>Rate:</strong> ${provider.hourlyRate}</p>
              <p><strong>Location:</strong> ${provider.location}</p>
            </div>
            <div class="profile-section">
              <h3 class="section-title">Specialties</h3>
              <div>${provider.specialties.map(s => `<span class="chip" style="background:#e5e7eb;padding:4px 8px;border-radius:12px;margin:2px;display:inline-block;font-size:0.8rem">${s}</span>`).join('')}</div>
            </div>
          </div>
        </div>
      `;

      // Initialize Calendar
      loadProviderSchedule(provider.id);
    }

    function loadProviderSchedule(providerId) {
      const bookedDates = mockProviderSchedules[providerId] || [];
      flatpickr("#providerCalendar", {
        inline: true,
        dateFormat: "Y-m-d",
        minDate: "today",
        disable: bookedDates,
        theme: "material_blue"
      });
    }

    // --- CHAT LOGIC ---
    function openChatWidget(serviceId, providerId) {
      const providers = serviceProviders[serviceId] || serviceProviders['cleaning'];
      const provider = providers.find(p => p.id === providerId);
      currentChatProvider = provider;
      const bgColor = getAvatarColor(provider.name);
      chatProviderAvatar.style.background = bgColor;
      chatProviderAvatar.textContent = initials(provider.name);
      chatProviderName.textContent = provider.name;
      chatProviderTitle.textContent = provider.title;
      chatMessages.innerHTML = '';
      addMessage('received', `Hello! I'm ${provider.name}. How can I help?`);
      chatOverlay.classList.remove('hidden');
    }
    function closeChatWidget() { chatOverlay.classList.add('hidden'); }
    function sendMessage() {
      const txt = chatInput.value.trim();
      if(!txt) return;
      addMessage('sent', txt);
      chatInput.value = '';
      setTimeout(() => addMessage('received', "Thanks for your message! I'll reply shortly."), 1000);
    }
    function sendQuickReply(txt) {
      addMessage('sent', txt);
      setTimeout(() => addMessage('received', "Thanks for asking! " + txt), 1000);
    }
    function addMessage(type, text) {
      const div = document.createElement('div');
      div.className = `chat-message ${type}`;
      div.textContent = text;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // --- OTHER UI ---
    document.getElementById('seeAllBtn').addEventListener('click', function() {
      showingAll = !showingAll;
      document.getElementById('moreServices').classList.toggle('hidden');
      this.textContent = showingAll ? "See Fewer" : "See All Services";
    });

    // --- AUTH ---
    auth.onAuthStateChanged(user => {
      if(user) {
        authContent.classList.remove('hidden');
        showHomePage();
        userAvatar.textContent = initials(user.email);
      } else {
        window.location.href = 'index.html';
      }
    });
    document.getElementById('signOutBtn').addEventListener('click', () => auth.signOut());
  </script>
</body>
</html>